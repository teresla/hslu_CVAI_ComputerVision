<!DOCTYPE html>
<html>
<head>
    <title>Aerial Image Analysis</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            height: 125px;
            width: 125px;
            margin: 20px auto;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        .results {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover {
            background-color: #45a049;
        }
        #log {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
        }
        .image-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        .image-box {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
        }
        .image-box img {
            max-width: 125px;
            max-height: 125px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Aerial Image Analysis</h1>
        <div id="map"></div>
        <button onclick="analyzeArea()">Analyze Area</button>
        <div class="image-container">
            <div class="image-box">
                <h3>Original</h3>
                <img id="originalImage" style="display: none;">
            </div>
            <div class="image-box">
                <h3>Segmented</h3>
                <img id="segmentedImage" style="display: none;">
            </div>
        </div>
        <div id="results" class="results" style="display: none;">
            <h2>Analysis Results</h2>
            <p>Meters per pixel: <span id="metersPerPixel"></span></p>
            <p>Paved area: <span id="pavedArea"></span>% (<span id="areaM2"></span> m²)</p>
        </div>
        <div id="log"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-image@0.4.0/leaflet-image.js"></script>
    <script>
        // Initialize map centered on Zurich with fixed zoom level 18
        const map = L.map('map').setView([47.376887, 8.541694], 18);
        
        // Use satellite imagery
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, FSA, UPR-EGP, and the GIS User Community'
        }).addTo(map);

        // Add scale bar
        L.control.scale({
            imperial: false,
            metric: true,
            position: 'bottomleft'
        }).addTo(map);

        // Disable all zoom controls
        map.scrollWheelZoom.disable();
        map.doubleClickZoom.disable();
        map.touchZoom.disable();
        map.boxZoom.disable();
        map.keyboard.disable();
        map.zoomControl.disable();

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function captureMapImage() {
            return new Promise((resolve, reject) => {
                leafletImage(map, function(err, canvas) {
                    if (err) {
                        reject(err);
                        return;
                    }
                    // Convert canvas to base64
                    const imageData = canvas.toDataURL('image/png');
                    resolve(imageData);
                });
            });
        }

        async function analyzeArea() {
            try {
                const center = map.getCenter();
                const zoom = map.getZoom();
                
                log(`Analyzing area at lat: ${center.lat.toFixed(6)}, lng: ${center.lng.toFixed(6)}, zoom: ${zoom}`);
                
                // Capture map image
                const imageData = await captureMapImage();
                document.getElementById('originalImage').src = imageData;
                document.getElementById('originalImage').style.display = 'block';
                
                // Send to backend for analysis
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lat: center.lat,
                        lng: center.lng,
                        zoom: zoom,
                        image: imageData
                    })
                });
                
                const data = await response.json();
                
                document.getElementById('results').style.display = 'block';
                document.getElementById('metersPerPixel').textContent = data.meters_per_pixel.toFixed(2);
                document.getElementById('pavedArea').textContent = data.segmentation_result.paved;
                document.getElementById('areaM2').textContent = data.segmentation_result.area_m2;
                
                // Display segmented image if available
                if (data.segmented_image) {
                    document.getElementById('segmentedImage').src = data.segmented_image;
                    document.getElementById('segmentedImage').style.display = 'block';
                }
                
                log(`Meters per pixel: ${data.meters_per_pixel.toFixed(2)}`);
                log(`Paved area: ${data.segmentation_result.paved}% (${data.segmentation_result.area_m2} m²)`);
            } catch (error) {
                console.error('Error:', error);
                log(`Error: ${error.message}`);
            }
        }

        // Initial log
        log('Map initialized at fixed zoom level 18');
    </script>
</body>
</html> 