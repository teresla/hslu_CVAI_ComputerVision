<!DOCTYPE html>
<html>
<head>
    <title>Aerial Image Analysis</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .left-panel {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ccc;
            width: 50%;
            position: relative;
            z-index: 1;
        }
        .right-panel {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            width: 50%;
            position: relative;
            z-index: 1;
        }
        .map-container {
            position: relative;
            margin-bottom: 20px;
            height: 600px;
            z-index: 1;
        }
        #map {
            width: 100% !important;
            height: 100% !important;
        }
        .button-container {
            margin: 10px 0;
        }
        button {
            padding: 15px 30px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
            width: 100%;
        }
        button:hover {
            background-color: #45a049;
        }
        .debug-area {
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .debug-area h3 {
            margin-top: 0;
        }
        .debug-image {
            max-width: 100%;
            height: auto;
            margin: 10px 0;
            border: 1px solid #ccc;
        }
        .results {
            margin-top: 20px;
        }
        .class-results {
            margin-top: 20px;
        }
        .legend {
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border: 1px solid #ccc;
        }
        #log {
            margin-top: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f5f5f5;
        }
        .segmentation-result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .segmentation-result img {
            width: 100%;
            height: auto;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="left-panel">
            <div class="map-container">
                <div id="map"></div>
            </div>
            <div class="button-container">
                <button onclick="analyzeArea()">Analyze Selected Area</button>
            </div>
            <div class="debug-area">
                <h3>Debug Information</h3>
                <div>
                    <strong>Input Image:</strong>
                    <img id="debugImage" class="debug-image" style="display: none;">
                    <p id="debugImageInfo"></p>
                </div>
            </div>
        </div>
        <div class="right-panel">
            <div id="results" class="results" style="display: none;">
                <h2>Analysis Results</h2>
                <div class="segmentation-result">
                    <h3>Segmentation Result</h3>
                    <img id="segmentationImage" style="display: none;">
                </div>
                <p>Meters per pixel: <span id="metersPerPixel"></span></p>
                <div id="classResults" class="class-results">
                    <!-- Results will be populated here -->
                </div>
                <div class="legend">
                    <h3>Class Legend</h3>
                    <div id="legendContent"></div>
                </div>
            </div>
            <div id="log"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-image@0.4.0/leaflet-image.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script>
        // Add this at the top of your script section
        const CLASS_COLORS = {
            'background': '#000000',
            'pavement': '#804080',
            'grass': '#00FF00',
            'vegetation': '#006600',
            'roof': '#464646',
            'water': '#1C2AA8',
            'car': '#098F96'
        };

        // Initialize map centered on Zurich with fixed zoom level 18
        const map = L.map('map').setView([47.376887, 8.541694], 18);
        setTimeout(() => {
            map.invalidateSize();
        }, 100);
        
        // Use Google Satellite imagery with higher zoom levels
        const satelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            attribution: 'Â© Google',
            maxZoom: 22  // Google Satellite supports up to zoom level 22
        }).addTo(map);

        // Add geocoder control for address search
        const geocoder = L.Control.geocoder({
            defaultMarkGeocode: false,
            placeholder: 'Search for an address...',
            errorMessage: 'Nothing found.'
        }).on('markgeocode', function(e) {
            const bbox = e.geocode.bbox;
            const poly = L.polygon([
                bbox.getSouthEast(),
                bbox.getNorthEast(),
                bbox.getNorthWest(),
                bbox.getSouthWest()
            ]);
            map.fitBounds(poly.getBounds());
        }).addTo(map);

        // Add scale bar
        L.control.scale({
            imperial: false,
            metric: true,
            position: 'bottomleft'
        }).addTo(map);

        // Enable zoom controls
        map.scrollWheelZoom.enable();
        map.doubleClickZoom.enable();
        map.touchZoom.enable();
        map.boxZoom.enable();
        map.keyboard.enable();
        map.zoomControl.enable();

        // Set minimum and maximum zoom levels
        map.setMinZoom(15);  // Don't zoom out too far
        map.setMaxZoom(22);  // Allow zooming in much closer

        // Add zoom level warning
        map.on('zoomend', function() {
            const currentZoom = map.getZoom();
            if (currentZoom >= 20) {
                log('Note: You are now at a very high zoom level. This may affect analysis accuracy.');
            }
        });

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function captureMapImage() {
            return new Promise((resolve, reject) => {
                leafletImage(map, function(err, canvas) {
                    if (err) {
                        reject(err);
                        return;
                    }
                    // Convert canvas to base64
                    const imageData = canvas.toDataURL('image/png');
                    resolve(imageData);
                });
            });
        }

        function updateDebugInfo(imageData) {
            const debugImage = document.getElementById('debugImage');
            const debugImageInfo = document.getElementById('debugImageInfo');
            
            debugImage.src = imageData;
            debugImage.style.display = 'block';
            
            // Create a temporary image to get dimensions
            const img = new Image();
            img.onload = function() {
                debugImageInfo.textContent = `Image dimensions: ${img.width}x${img.height} pixels`;
            };
            img.src = imageData;
        }

        function updateLegend(stats) {
            const legendContent = document.getElementById('legendContent');
            legendContent.innerHTML = '';
            
            Object.entries(stats).forEach(([className, data]) => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                
                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = data.color;
                
                const label = document.createElement('span');
                label.textContent = `${className}: ${data.percentage.toFixed(2)}%`;
                
                item.appendChild(colorBox);
                item.appendChild(label);
                legendContent.appendChild(item);
            });
        }

        async function analyzeArea() {
            try {
                const center = map.getCenter();
                const zoom = map.getZoom();
                
                log(`Analyzing area at lat: ${center.lat.toFixed(6)}, lng: ${center.lng.toFixed(6)}, zoom: ${zoom}`);
                
                // Capture map image
                const imageData = await captureMapImage();
                updateDebugInfo(imageData);
                
                // Send to backend for analysis
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lat: center.lat,
                        lng: center.lng,
                        zoom: zoom,
                        image: imageData
                    })
                });
                
                const data = await response.json();
                
                document.getElementById('results').style.display = 'block';
                document.getElementById('metersPerPixel').textContent = data.meters_per_pixel.toFixed(2);
                
                // Display segmentation image
                const segmentationImage = document.getElementById('segmentationImage');
                segmentationImage.src = data.segmented_image;
                segmentationImage.style.display = 'block';
                
                // Update class results
                const classResultsDiv = document.getElementById('classResults');
                classResultsDiv.innerHTML = ''; // Clear previous results
                
                // Sort classes by percentage (highest first)
                const sortedClasses = Object.entries(data.segmentation_result)
                    .sort((a, b) => b[1].percentage - a[1].percentage);
                
                // Create results table
                const table = document.createElement('table');
                
                // Add header
                const header = table.createTHead();
                const headerRow = header.insertRow();
                ['Class', 'Color', 'Percentage', 'Area (mÂ²)'].forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    headerRow.appendChild(th);
                });
                
                // Add rows for each class
                const tbody = table.createTBody();
                sortedClasses.forEach(([className, stats]) => {
                    const row = tbody.insertRow();
                    
                    // Class name
                    const nameCell = row.insertCell();
                    nameCell.textContent = className;
                    
                    // Color
                    const colorCell = row.insertCell();
                    const colorBox = document.createElement('div');
                    colorBox.style.width = '20px';
                    colorBox.style.height = '20px';
                    colorBox.style.backgroundColor = stats.color;
                    colorBox.style.border = '1px solid #ccc';
                    colorCell.appendChild(colorBox);
                    
                    // Percentage
                    const percentCell = row.insertCell();
                    percentCell.textContent = `${stats.percentage.toFixed(2)}%`;
                    
                    // Area
                    const areaCell = row.insertCell();
                    areaCell.textContent = `${stats.area_m2.toFixed(2)} mÂ²`;
                });
                
                classResultsDiv.appendChild(table);
                updateLegend(data.segmentation_result);

                
                log('Analysis complete');
                
            } catch (error) {
                log(`Error: ${error.message}`);
                console.error('Error:', error);
            }
        }

        // Initial log
        log('Map initialized at fixed zoom level 18');
    </script>
</body>
</html> 